/*
Copyright (c) 2018 Tomasz "VedVid" Nowakowski

This software is provided 'as-is', without any express or implied
warranty. In no event will the authors be held liable for any damages
arising from the use of this software.

Permission is granted to anyone to use this software for any purpose,
including commercial applications, and to alter it and redistribute it
freely, subject to the following restrictions:

1. The origin of this software must not be misrepresented; you must not
   claim that you wrote the original software. If you use this software
   in a product, an acknowledgment in the product documentation would be
   appreciated but is not required.
2. Altered source versions must be plainly marked as such, and must not be
   misrepresented as being the original software.
3. This notice may not be removed or altered from any source distribution.
*/

package main

import (
	"math"
)

const (
	//values for handling field of view algorithm execution
	FOVRays   = 360 //whole area around player; it may not work properly with other values
	FOVLength = 5   //sight range
	FOVStep   = 1
)

var (
	sinBase = []float64{
		0.00000, 0.01745, 0.03490, 0.05234, 0.06976, 0.08716, 0.10453,
		0.12187, 0.13917, 0.15643, 0.17365, 0.19081, 0.20791, 0.22495, 0.24192,
		0.25882, 0.27564, 0.29237, 0.30902, 0.32557, 0.34202, 0.35837, 0.37461,
		0.39073, 0.40674, 0.42262, 0.43837, 0.45399, 0.46947, 0.48481, 0.50000,
		0.51504, 0.52992, 0.54464, 0.55919, 0.57358, 0.58779, 0.60182, 0.61566,
		0.62932, 0.64279, 0.65606, 0.66913, 0.68200, 0.69466, 0.70711, 0.71934,
		0.73135, 0.74314, 0.75471, 0.76604, 0.77715, 0.78801, 0.79864, 0.80902,
		0.81915, 0.82904, 0.83867, 0.84805, 0.85717, 0.86603, 0.87462, 0.88295,
		0.89101, 0.89879, 0.90631, 0.91355, 0.92050, 0.92718, 0.93358, 0.93969,
		0.94552, 0.95106, 0.95630, 0.96126, 0.96593, 0.97030, 0.97437, 0.97815,
		0.98163, 0.98481, 0.98769, 0.99027, 0.99255, 0.99452, 0.99619, 0.99756,
		0.99863, 0.99939, 0.99985, 1.00000, 0.99985, 0.99939, 0.99863, 0.99756,
		0.99619, 0.99452, 0.99255, 0.99027, 0.98769, 0.98481, 0.98163, 0.97815,
		0.97437, 0.97030, 0.96593, 0.96126, 0.95630, 0.95106, 0.94552, 0.93969,
		0.93358, 0.92718, 0.92050, 0.91355, 0.90631, 0.89879, 0.89101, 0.88295,
		0.87462, 0.86603, 0.85717, 0.84805, 0.83867, 0.82904, 0.81915, 0.80902,
		0.79864, 0.78801, 0.77715, 0.76604, 0.75471, 0.74314, 0.73135, 0.71934,
		0.70711, 0.69466, 0.68200, 0.66913, 0.65606, 0.64279, 0.62932, 0.61566,
		0.60182, 0.58779, 0.57358, 0.55919, 0.54464, 0.52992, 0.51504, 0.50000,
		0.48481, 0.46947, 0.45399, 0.43837, 0.42262, 0.40674, 0.39073, 0.37461,
		0.35837, 0.34202, 0.32557, 0.30902, 0.29237, 0.27564, 0.25882, 0.24192,
		0.22495, 0.20791, 0.19081, 0.17365, 0.15643, 0.13917, 0.12187, 0.10453,
		0.08716, 0.06976, 0.05234, 0.03490, 0.01745, 0.00000, -0.01745, -0.03490,
		-0.05234, -0.06976, -0.08716, -0.10453, -0.12187, -0.13917, -0.15643,
		-0.17365, -0.19081, -0.20791, -0.22495, -0.24192, -0.25882, -0.27564,
		-0.29237, -0.30902, -0.32557, -0.34202, -0.35837, -0.37461, -0.39073,
		-0.40674, -0.42262, -0.43837, -0.45399, -0.46947, -0.48481, -0.50000,
		-0.51504, -0.52992, -0.54464, -0.55919, -0.57358, -0.58779, -0.60182,
		-0.61566, -0.62932, -0.64279, -0.65606, -0.66913, -0.68200, -0.69466,
		-0.70711, -0.71934, -0.73135, -0.74314, -0.75471, -0.76604, -0.77715,
		-0.78801, -0.79864, -0.80902, -0.81915, -0.82904, -0.83867, -0.84805,
		-0.85717, -0.86603, -0.87462, -0.88295, -0.89101, -0.89879, -0.90631,
		-0.91355, -0.92050, -0.92718, -0.93358, -0.93969, -0.94552, -0.95106,
		-0.95630, -0.96126, -0.96593, -0.97030, -0.97437, -0.97815, -0.98163,
		-0.98481, -0.98769, -0.99027, -0.99255, -0.99452, -0.99619, -0.99756,
		-0.99863, -0.99939, -0.99985, -1.00000, -0.99985, -0.99939, -0.99863,
		-0.99756, -0.99619, -0.99452, -0.99255, -0.99027, -0.98769, -0.98481,
		-0.98163, -0.97815, -0.97437, -0.97030, -0.96593, -0.96126, -0.95630,
		-0.95106, -0.94552, -0.93969, -0.93358, -0.92718, -0.92050, -0.91355,
		-0.90631, -0.89879, -0.89101, -0.88295, -0.87462, -0.86603, -0.85717,
		-0.84805, -0.83867, -0.82904, -0.81915, -0.80902, -0.79864, -0.78801,
		-0.77715, -0.76604, -0.75471, -0.74314, -0.73135, -0.71934, -0.70711,
		-0.69466, -0.68200, -0.66913, -0.65606, -0.64279, -0.62932, -0.61566,
		-0.60182, -0.58779, -0.57358, -0.55919, -0.54464, -0.52992, -0.51504,
		-0.50000, -0.48481, -0.46947, -0.45399, -0.43837, -0.42262, -0.40674,
		-0.39073, -0.37461, -0.35837, -0.34202, -0.32557, -0.30902, -0.29237,
		-0.27564, -0.25882, -0.24192, -0.22495, -0.20791, -0.19081, -0.17365,
		-0.15643, -0.13917, -0.12187, -0.10453, -0.08716, -0.06976, -0.05234,
		-0.03490, -0.01745, -0.00000,
	}
	cosBase = []float64{
		1.00000, 0.99985, 0.99939, 0.99863, 0.99756, 0.99619, 0.99452,
		0.99255, 0.99027, 0.98769, 0.98481, 0.98163, 0.97815, 0.97437, 0.97030,
		0.96593, 0.96126, 0.95630, 0.95106, 0.94552, 0.93969, 0.93358, 0.92718,
		0.92050, 0.91355, 0.90631, 0.89879, 0.89101, 0.88295, 0.87462, 0.86603,
		0.85717, 0.84805, 0.83867, 0.82904, 0.81915, 0.80902, 0.79864, 0.78801,
		0.77715, 0.76604, 0.75471, 0.74314, 0.73135, 0.71934, 0.70711, 0.69466,
		0.68200, 0.66913, 0.65606, 0.64279, 0.62932, 0.61566, 0.60182, 0.58779,
		0.57358, 0.55919, 0.54464, 0.52992, 0.51504, 0.50000, 0.48481, 0.46947,
		0.45399, 0.43837, 0.42262, 0.40674, 0.39073, 0.37461, 0.35837, 0.34202,
		0.32557, 0.30902, 0.29237, 0.27564, 0.25882, 0.24192, 0.22495, 0.20791,
		0.19081, 0.17365, 0.15643, 0.13917, 0.12187, 0.10453, 0.08716, 0.06976,
		0.05234, 0.03490, 0.01745, 0.00000, -0.01745, -0.03490, -0.05234, -0.06976,
		-0.08716, -0.10453, -0.12187, -0.13917, -0.15643, -0.17365, -0.19081,
		-0.20791, -0.22495, -0.24192, -0.25882, -0.27564, -0.29237, -0.30902,
		-0.32557, -0.34202, -0.35837, -0.37461, -0.39073, -0.40674, -0.42262,
		-0.43837, -0.45399, -0.46947, -0.48481, -0.50000, -0.51504, -0.52992,
		-0.54464, -0.55919, -0.57358, -0.58779, -0.60182, -0.61566, -0.62932,
		-0.64279, -0.65606, -0.66913, -0.68200, -0.69466, -0.70711, -0.71934,
		-0.73135, -0.74314, -0.75471, -0.76604, -0.77715, -0.78801, -0.79864,
		-0.80902, -0.81915, -0.82904, -0.83867, -0.84805, -0.85717, -0.86603,
		-0.87462, -0.88295, -0.89101, -0.89879, -0.90631, -0.91355, -0.92050,
		-0.92718, -0.93358, -0.93969, -0.94552, -0.95106, -0.95630, -0.96126,
		-0.96593, -0.97030, -0.97437, -0.97815, -0.98163, -0.98481, -0.98769,
		-0.99027, -0.99255, -0.99452, -0.99619, -0.99756, -0.99863, -0.99939,
		-0.99985, -1.00000, -0.99985, -0.99939, -0.99863, -0.99756, -0.99619,
		-0.99452, -0.99255, -0.99027, -0.98769, -0.98481, -0.98163, -0.97815,
		-0.97437, -0.97030, -0.96593, -0.96126, -0.95630, -0.95106, -0.94552,
		-0.93969, -0.93358, -0.92718, -0.92050, -0.91355, -0.90631, -0.89879,
		-0.89101, -0.88295, -0.87462, -0.86603, -0.85717, -0.84805, -0.83867,
		-0.82904, -0.81915, -0.80902, -0.79864, -0.78801, -0.77715, -0.76604,
		-0.75471, -0.74314, -0.73135, -0.71934, -0.70711, -0.69466, -0.68200,
		-0.66913, -0.65606, -0.64279, -0.62932, -0.61566, -0.60182, -0.58779,
		-0.57358, -0.55919, -0.54464, -0.52992, -0.51504, -0.50000, -0.48481,
		-0.46947, -0.45399, -0.43837, -0.42262, -0.40674, -0.39073, -0.37461,
		-0.35837, -0.34202, -0.32557, -0.30902, -0.29237, -0.27564, -0.25882,
		-0.24192, -0.22495, -0.20791, -0.19081, -0.17365, -0.15643, -0.13917,
		-0.12187, -0.10453, -0.08716, -0.06976, -0.05234, -0.03490, -0.01745,
		-0.00000, 0.01745, 0.03490, 0.05234, 0.06976, 0.08716, 0.10453, 0.12187,
		0.13917, 0.15643, 0.17365, 0.19081, 0.20791, 0.22495, 0.24192, 0.25882,
		0.27564, 0.29237, 0.30902, 0.32557, 0.34202, 0.35837, 0.37461, 0.39073,
		0.40674, 0.42262, 0.43837, 0.45399, 0.46947, 0.48481, 0.50000, 0.51504,
		0.52992, 0.54464, 0.55919, 0.57358, 0.58779, 0.60182, 0.61566, 0.62932,
		0.64279, 0.65606, 0.66913, 0.68200, 0.69466, 0.70711, 0.71934, 0.73135,
		0.74314, 0.75471, 0.76604, 0.77715, 0.78801, 0.79864, 0.80902, 0.81915,
		0.82904, 0.83867, 0.84805, 0.85717, 0.86603, 0.87462, 0.88295, 0.89101,
		0.89879, 0.90631, 0.91355, 0.92050, 0.92718, 0.93358, 0.93969, 0.94552,
		0.95106, 0.95630, 0.96126, 0.96593, 0.97030, 0.97437, 0.97815, 0.98163,
		0.98481, 0.98769, 0.99027, 0.99255, 0.99452, 0.99619, 0.99756, 0.99863,
		0.99939, 0.99985, 1.00000,
	}
)

func round64(value, rounding float64, places int) float64 {
	/* Function round64 rounds float64 values (value) to specified
	   number of digits (places) using given point-of-rounding-up (rounding).*/
	pow := math.Pow(10, float64(places))
	digit := pow * value
	_, div := math.Modf(digit)
	var round float64
	if value > 0 {
		if div >= rounding {
			round = math.Ceil(digit)
		} else {
			round = math.Floor(digit)
		}
	} else {
		if div > rounding {
			round = math.Floor(digit)
		} else {
			round = math.Ceil(digit)
		}
	}
	return round / pow
}

func round64ToInt(value float64) int {
	/* Function round64ToInt gets float64 value, uses round64 function,
	   then returns new value converted to integer.*/
	a := round64(value, 0.5, 0)
	return int(a)
}

func CastRays(b Board, sx, sy int) {
	/* Function castRays is simple raycasting function for turning tiles to explored.
	   It casts (fovRays / fovStep) rays (bigger fovStep means faster but
	   more error-prone raycasting) from player to coordinates in fovLength range.
	   Source of algorithm:
	   http://www.roguebasin.com/index.php?title=Raycasting_in_python [20170712]*/
	for i := 0; i < FOVRays; i += FOVStep {
		rayX := sinBase[i]
		rayY := cosBase[i]
		x := float64(sx)
		y := float64(sy)
		t1, _ := FindTileByXY(b, round64ToInt(x), round64ToInt(y))
		t1.Explored = true
		for j := 0; j < FOVLength; j++ {
			x -= rayX
			y -= rayY
			if x < 0 || y < 0 || x > WindowSizeX-1 || y > WindowSizeY-1 {
				break
			}
			t2, _ := FindTileByXY(b, round64ToInt(x), round64ToInt(y))
			t2.Explored = true
			if t2.Blocked {
				break
			}
		}
	}
}

func IsInFOV(b Board, sx, sy, tx, ty int) bool {
	/* Function isInFOV checks if target (tx, ty) is in fov of source (sx, sy).
	   Returns true if tx, ty == sx, sy; otherwise, it casts (FOVRays / fovStep)
	   rays (bigger fovStep means faster but more error-prone algorithm)
	   from source to tiles in fovLength range; stops if cell is blocked.
	   Source of algorithm:
	   http://www.roguebasin.com/index.php?title=Raycasting_in_python [20170712].*/
	if sx == tx && sy == ty {
		return true
	}
	for i := 0; i < FOVRays; i += FOVStep {
		rayX := sinBase[i]
		rayY := cosBase[i]
		x := float64(sx)
		y := float64(sy)
		for j := 0; j < FOVLength; j++ {
			x -= rayX
			y -= rayY
			if x < 0 || y < 0 || x > WindowSizeX-1 || y > WindowSizeY-1 {
				break
			}
			bx, by := round64ToInt(x), round64ToInt(y)
			if bx == tx && by == ty {
				return true
			}
			t, _ := FindTileByXY(b, bx, by)
			if t.Blocked {
				break
			}
		}
	}
	return false
}
